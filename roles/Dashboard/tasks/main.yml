#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/Dashboard
- name: check if host is in target group before start tasks
  block:
    - name: debug if host is not in compute group
      ansible.builtin.debug:
        msg: "Host {{ inventory_hostname }} is not in compute group, stopping execution"
      when: "'controller' not in group_names"

    - name: stop running role on hosts not in compute
      meta: end_host
      when: "'controller' not in group_names"

- name: ensure mark directory exists
  ansible.builtin.file:
    path: "{{ mark_dir_path }}"
    state: directory
    mode: '0755'

- name: install and configure copnetsack-dashboard 
  block:
    - name: install dashboard packages
      ansible.builtin.dnf:
        name: openstack-dashboard
        state: latest

- name: OpenStack Horizon static resources
  block:
    - name: deploy conf template files
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      loop:
        - { src: "{{ dashboard_conf_template_path.local_settings }}",dest: "{{ dashboard_conf_path.local_settings }}" }
        - { src: "{{ dashboard_conf_template_path.defaults_py }}" ,dest: "{{ dashboard_conf_path.defaults_py }}" }
        - { src: "{{ dashboard_conf_template_path.openstack_dashboard_conf }}",dest: "{{ dashboard_conf_path.openstack_dashboard_conf }}" }
        - { src: "{{ dashboard_conf_template_path.settings_py }}" ,dest: "{{ dashboard_conf_path.settings_py }}" }

    - name: collect Horizon static files
      ansible.builtin.command: python3 manage.py collectstatic --noinput --clear
      args:
        chdir: /usr/share/openstack-dashboard
      become: yes
      become_user: apache

    - name: Compress Horizon static files
      ansible.builtin.command: python3 manage.py compress --force
      args:
        chdir: /usr/share/openstack-dashboard
      become: yes
      become_user: apache
      notify:
        - restart httpd
        - restart memcached
